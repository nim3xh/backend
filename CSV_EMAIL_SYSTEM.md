# âœ… CSV-Based Automatic Email System - ENABLED

## How It Works

The system now automatically sends subscription emails by monitoring the Stripe subscriptions CSV file:

```
Every 1 minute â†’ Stripe exports subscriptions to CSV â†’ 
CSV Watcher detects new entries â†’ Sends email automatically
```

---

## System Components

### 1. **Cron Job** (Every 1 minute)
   - Exports all Stripe subscriptions to `stripe/subscriptions.csv`
   - File: `checkStripeSubscriptions.js`

### 2. **CSV File Watcher** (Every 5 seconds)
   - Monitors `stripe/subscriptions.csv` for changes
   - Detects new subscriptions
   - Sends emails to new customers
   - File: `csvEmailWatcher.js`

### 3. **Email Tracker**
   - Prevents duplicate emails
   - Records all sent emails
   - Tracks subscription history
   - File: `subscriptionTracker.js`

---

## Email Sending Rules

### âœ… Emails ARE Sent When:
- New subscription appears in CSV
- Status is `active` or `trialing`
- Email hasn't been sent for this subscription ID before

### â­ï¸ Emails ARE NOT Sent When:
- Subscription already exists in tracking database
- Status is `canceled`, `incomplete`, or other non-active states
- Email was already sent for this subscription ID

---

## Configuration

### Environment Variables (.env)

```env
# Required
STRIPE_SECRET_KEY='your_stripe_secret_key'
GMAIL_USER='your_email@gmail.com'
GMAIL_APP_PASSWORD='your_gmail_app_password'

# Optional
PORT=3000
DEFAULT_DOWNLOAD_LINK='https://app.technests.ai/download/proptraderpro'

# Per-product download links (optional)
PRODUCT_DOWNLOAD_LINK_price_xxxxx=https://example.com/download/product1
```

### Timing Configuration

You can adjust timing in the code:

**Cron Job** (`server.js`):
```javascript
cron.schedule("*/1 * * * *", async () => {
  // Runs every 1 minute
  await checkStripeSubscriptions();
});
```

**CSV Watcher** (`csvEmailWatcher.js`):
```javascript
const WATCH_INTERVAL = 5000; // Check every 5 seconds
```

---

## File Structure

```
backend/
â”œâ”€â”€ server.js                       # Main server with cron job
â”œâ”€â”€ csvEmailWatcher.js              # NEW - CSV file watcher
â”œâ”€â”€ checkStripeSubscriptions.js     # Exports Stripe data to CSV
â”œâ”€â”€ emailService.js                 # Email sending functions
â”œâ”€â”€ subscriptionTracker.js          # Tracks sent emails
â”œâ”€â”€ stripe/
â”‚   â””â”€â”€ subscriptions.csv           # Auto-generated by cron job
â”œâ”€â”€ subscription_emails_log.json    # Email tracking database
â””â”€â”€ subscription_emails_sent.csv    # Email history CSV
```

---

## How to Use

### 1. Start the Server

```bash
npm start
# or
node server.js
```

### 2. What Happens

```
Server starts â†’ 
CSV Watcher starts monitoring â†’
Cron job runs every minute â†’
New subscriptions detected â†’
Emails sent automatically
```

### 3. Monitor Logs

Watch for these messages:

```
ðŸ” CSV Email Watcher Started
ðŸ“ Watching: [path]/stripe/subscriptions.csv
â±ï¸  Check interval: 5 seconds

[CRON] Running Stripe subscription export...
[CRON] Finished Stripe subscription export.

ðŸ“§ New subscription detected!
   Email: customer@example.com
   Plan: TradeCam
   Status: active
   Subscription ID: sub_xxxxx
âœ… Email sent and recorded for customer@example.com
```

---

## Testing

### Test Email Manually

```bash
# Test email service
curl -X POST http://localhost:3000/send-test-email \
  -H "Content-Type: application/json" \
  -d '{"to":"test@example.com"}'
```

### View Sent Emails

```bash
# Get all sent emails
curl http://localhost:3000/subscription-emails

# Get emails for specific address
curl http://localhost:3000/subscription-emails/customer@example.com

# Get statistics
curl http://localhost:3000/subscription-emails-stats
```

### Force CSV Export

```bash
npm run subscriptions:export
```

### Manual CSV Check

```bash
node -e "require('./csvEmailWatcher').checkForNewSubscriptions()"
```

---

## Email Features

### Professional HTML Template
- Gradient header design
- Personalized greeting
- Product name display
- Download button
- Getting started guide
- Professional footer

### Example Email Content:
```
Subject: Thank You for Your Subscription to TradeCam!

Dear John,

Thank you for subscribing to TradeCam!

[Download Button]

What's Next?
â€¢ Download and install your product
â€¢ Explore all the features
â€¢ Contact support if needed
```

---

## Advantages Over Webhooks

âœ… **No webhook setup required** - No need for public endpoint
âœ… **No SSL/HTTPS needed** - Works on localhost
âœ… **No Stripe configuration** - No webhook secrets
âœ… **Easy to test** - Just update the CSV file
âœ… **Reliable** - Checks CSV periodically, won't miss updates
âœ… **Simple debugging** - Easy to see what's in the CSV

---

## Troubleshooting

### No emails being sent?

**Check 1**: Is the CSV file being created?
```bash
ls -la stripe/subscriptions.csv
```

**Check 2**: Is the watcher running?
- Look for "CSV Email Watcher Started" in logs

**Check 3**: Are subscriptions in CSV?
```bash
cat stripe/subscriptions.csv
```

**Check 4**: Gmail credentials correct?
- Check `GMAIL_USER` and `GMAIL_APP_PASSWORD` in `.env`

### Emails sent multiple times?

- Check `subscription_emails_log.json` for duplicates
- Tracker should prevent this automatically

### CSV not updating?

**Check 1**: Is cron job running?
- Look for "[CRON] Running Stripe subscription export..." in logs

**Check 2**: Stripe API key valid?
- Check `STRIPE_SECRET_KEY` in `.env`

**Check 3**: Run export manually:
```bash
npm run subscriptions:export
```

---

## Monitoring

### Files to Watch

1. **stripe/subscriptions.csv** - Latest Stripe data
2. **subscription_emails_log.json** - Email tracking database
3. **subscription_emails_sent.csv** - Email history

### Key Logs

```
âœ… Success: "Email sent and recorded for [email]"
â­ï¸ Skipped: "Email already sent for [email]"
âŒ Error: "Error processing subscription"
```

---

## Advanced Configuration

### Change Check Frequency

**Make it faster** (check every 3 seconds):
```javascript
// In csvEmailWatcher.js
const WATCH_INTERVAL = 3000;
```

**Make it slower** (check every 10 seconds):
```javascript
// In csvEmailWatcher.js
const WATCH_INTERVAL = 10000;
```

### Change Export Frequency

**Every 30 seconds**:
```javascript
// In server.js
cron.schedule("*/30 * * * * *", async () => {
```

**Every 5 minutes**:
```javascript
// In server.js
cron.schedule("*/5 * * * *", async () => {
```

---

## API Endpoints

### View Email Records

```bash
GET /subscription-emails
GET /subscription-emails/:email
GET /subscription-emails-stats
```

### Test Email

```bash
POST /send-test-email
Body: {"to": "test@example.com"}
```

---

## Production Checklist

- [x] Gmail credentials configured in `.env`
- [x] Stripe API key configured in `.env`
- [x] Default download link set in `.env`
- [x] Product-specific download links configured (optional)
- [x] Server running with `npm start` or `pm2`
- [x] CSV watcher started (automatic on server start)
- [x] Cron job running (automatic on server start)
- [x] Logs being monitored

---

## Differences from Webhook Version

| Feature | Webhook | CSV Watcher |
|---------|---------|-------------|
| Setup | Complex | Simple |
| Public endpoint | Required | Not needed |
| SSL/HTTPS | Required | Not needed |
| Stripe config | Webhook secret | Just API key |
| Latency | Instant | 1-5 minutes |
| Reliability | Depends on network | Very reliable |
| Testing | Complex | Easy |
| Local dev | Needs tunneling | Works directly |

---

## Support Files

- `emailService.js` - Email templates and sending
- `subscriptionTracker.js` - Duplicate prevention
- `checkStripeSubscriptions.js` - Stripe data export
- `csvEmailWatcher.js` - CSV monitoring
- `server.js` - Main server with integrations

---

**Status**: âœ… Active and Ready
**Method**: CSV File Monitoring
**Frequency**: Checks every 5 seconds, exports every 1 minute
**Date Enabled**: November 21, 2025
